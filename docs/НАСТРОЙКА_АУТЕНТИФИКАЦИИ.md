# Настройка системы аутентификации и запросов к эксперту

## Шаг 1: Установка зависимостей

```bash
pip install -r requirements.txt
```

Это установит Flask-Login для работы с аутентификацией.

## Шаг 2: Создание таблиц в базе данных

Выполните SQL скрипт для создания необходимых таблиц:

```bash
python scripts/run_sql.py sql/add_auth_and_requests.sql
```

Или напрямую через psql:

```bash
psql -U postgres -d insects_db -f sql/add_auth_and_requests.sql
```

Этот скрипт:
- Расширит таблицу `Пользователь` полями для пароля, роли и username
- Создаст таблицу `ЗапросЭксперту` для хранения запросов к эксперту
- Создаст первого администратора (логин: `admin`, пароль: `admin123`)

## Шаг 3: Настройка секретного ключа

Для продакшена установите переменную окружения:

```bash
export SECRET_KEY="ваш-секретный-ключ-для-сессий"
```

Или создайте файл `.env`:

```
SECRET_KEY=ваш-секретный-ключ-для-сессий
```

## Шаг 4: Запуск приложения

```bash
python app.py
```

## Использование

### Регистрация пользователя

1. Откройте http://localhost:5001
2. Нажмите "Регистрация"
3. Заполните форму:
   - Логин
   - Имя
   - Email
   - Пароль

### Вход в систему

1. Нажмите "Войти"
2. Введите логин и пароль

### Создание запроса к эксперту

1. Войдите в систему
2. Нажмите "Задать вопрос эксперту"
3. Заполните форму:
   - **Описание насекомого** (обязательно) - опишите насекомое словами
   - Место наблюдения
   - Дата наблюдения
   - Дополнительная информация
4. Нажмите "Отправить эксперту"

### Работа админа/эксперта

1. Войдите как администратор (логин: `admin`, пароль: `admin123`)
2. Перейдите в "Админ-панель"
3. Просмотрите все запросы
4. Ответьте на запрос:
   - Введите ответ
   - (Опционально) Укажите URL изображения
   - (Опционально) Укажите ID вида насекомого из БД
5. Нажмите "Отправить ответ"

## Структура таблиц

### Таблица Пользователь (расширена)

- `id_пользователя` - ID пользователя
- `username` - Логин (уникальный)
- `email` - Email
- `имя` - Имя пользователя
- `пароль` - Хешированный пароль
- `роль` - Роль: 'пользователь', 'админ', 'эксперт'

### Таблица ЗапросЭксперту

- `id_запроса` - ID запроса
- `id_пользователя` - Кто создал запрос
- `описание_насекомого` - Текстовое описание
- `место_наблюдения` - Где видели
- `дата_наблюдения` - Когда видели
- `дополнительные_данные` - Дополнительная информация
- `статус` - 'ожидает', 'в_работе', 'отвечено', 'отклонено'
- `дата_создания` - Когда создан
- `дата_ответа` - Когда ответили
- `ответ_эксперта` - Текст ответа
- `изображение_ответа` - URL изображения от эксперта
- `id_вида_насекомого` - Определенный вид (если есть)
- `id_эксперта` - Кто ответил

## Безопасность

⚠️ **Важно для продакшена:**

1. Измените пароль администратора после первого входа
2. Установите надежный SECRET_KEY
3. Используйте HTTPS
4. Регулярно обновляйте зависимости

## API Endpoints

### Аутентификация

- `POST /login` - Вход в систему
- `POST /register` - Регистрация
- `POST /logout` - Выход

### Запросы к эксперту

- `POST /api/expert-request` - Создать запрос (требует авторизации)
- `GET /api/expert-requests` - Получить запросы (требует авторизации)
  - Пользователь видит только свои запросы
  - Админ видит все запросы
- `POST /api/expert-request/<id>/answer` - Ответить на запрос (только админ)

### Админ-панель

- `GET /admin` - Админ-панель (требует авторизации и роль админ)

